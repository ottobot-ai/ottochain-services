name: Auto-Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_integration_tests:
        description: 'Skip integration tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  ENVIRONMENT: staging

jobs:
  # Full CI validation for staging
  full-ci:
    name: Full CI Validation
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: ottochain
          POSTGRES_PASSWORD: ottochain
          POSTGRES_DB: ottochain_identity
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Type checking
        run: pnpm -r exec tsc --noEmit

      - name: Linting
        run: pnpm lint

      - name: Unit tests with coverage
        run: pnpm test:coverage

      - name: Build all packages
        run: pnpm build

      - name: Database schema validation
        env:
          DATABASE_URL: postgresql://ottochain:ottochain@localhost:5432/ottochain_identity
        run: |
          pnpm db:push --skip-generate
          pnpm db:generate

  # Integration tests
  integration-tests:
    name: Integration Testing
    runs-on: ubuntu-latest
    needs: full-ci
    if: ${{ !inputs.skip_integration_tests }}
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: ottochain
          POSTGRES_PASSWORD: ottochain
          POSTGRES_DB: ottochain_identity
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Setup test database
        env:
          DATABASE_URL: postgresql://ottochain:ottochain@localhost:5432/ottochain_identity
        run: |
          pnpm db:push --skip-generate

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://ottochain:ottochain@localhost:5432/ottochain_identity
          REDIS_URL: redis://localhost:6379
        run: |
          pnpm test:integration

  # Build staging Docker images
  build-staging:
    name: Build Staging Images
    runs-on: ubuntu-latest
    needs: [full-ci]
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Generate staging version
        id: version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          STAGING_VERSION="${PACKAGE_VERSION}-staging-${{ github.run_number }}"
          echo "version=$STAGING_VERSION" >> $GITHUB_OUTPUT
          echo "Staging version: $STAGING_VERSION"

      - name: Build packages
        run: pnpm build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push staging images
        run: |
          # Build bridge service
          docker buildx build \
            --platform linux/amd64 \
            --tag ghcr.io/ottobot-ai/ottochain-bridge:${{ steps.version.outputs.version }} \
            --tag ghcr.io/ottobot-ai/ottochain-bridge:staging-latest \
            --push \
            --file packages/bridge/Dockerfile \
            .

          # Build indexer service
          docker buildx build \
            --platform linux/amd64 \
            --tag ghcr.io/ottobot-ai/ottochain-indexer:${{ steps.version.outputs.version }} \
            --tag ghcr.io/ottobot-ai/ottochain-indexer:staging-latest \
            --push \
            --file packages/indexer/Dockerfile \
            .

          # Build gateway service
          docker buildx build \
            --platform linux/amd64 \
            --tag ghcr.io/ottobot-ai/ottochain-gateway:${{ steps.version.outputs.version }} \
            --tag ghcr.io/ottobot-ai/ottochain-gateway:staging-latest \
            --push \
            --file packages/gateway/Dockerfile \
            .

      - name: Generate deployment manifest
        run: |
          cat > deployment-manifest.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "staging",
            "images": {
              "bridge": "ghcr.io/ottobot-ai/ottochain-bridge:${{ steps.version.outputs.version }}",
              "indexer": "ghcr.io/ottobot-ai/ottochain-indexer:${{ steps.version.outputs.version }}",
              "gateway": "ghcr.io/ottobot-ai/ottochain-gateway:${{ steps.version.outputs.version }}"
            },
            "tests_passed": {
              "unit": true,
              "integration": ${{ !inputs.skip_integration_tests }},
              "schema": true,
              "lint": true
            }
          }
          EOF

      - name: Upload deployment manifest
        uses: actions/upload-artifact@v4
        with:
          name: staging-services-manifest-${{ github.run_number }}
          path: deployment-manifest.json
          retention-days: 30

  # Deploy to staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [full-ci, build-staging]
    if: success() && (needs.integration-tests.result == 'success' || inputs.skip_integration_tests)
    environment: 
      name: staging
      url: https://staging.ottochain.ai
    
    steps:
      - name: Validate deployment readiness
        run: |
          echo "âœ… Full CI validation passed"
          echo "âœ… Staging images built successfully"
          if [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "âœ… Integration tests passed"
          else
            echo "âš ï¸ Integration tests skipped"
          fi

      - name: Trigger staging services deployment
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.OTTOCHAIN_DEPLOY_TOKEN }}
          repository: ottobot-ai/ottochain-deploy
          event-type: deploy-services-staging
          client-payload: |
            {
              "source_repo": "ottochain-services",
              "branch": "${{ github.ref_name }}",
              "version": "${{ needs.build-staging.outputs.version }}",
              "commit_sha": "${{ github.sha }}",
              "manifest_artifact": "staging-services-manifest-${{ github.run_number }}",
              "run_id": "${{ github.run_id }}",
              "environment": "staging",
              "skip_integration_tests": "${{ inputs.skip_integration_tests }}"
            }

      - name: Staging services deployment notification
        run: |
          echo "ðŸš€ Staging services deployment initiated"
          echo "Version: ${{ needs.build-staging.outputs.version }}"
          echo "Environment: https://staging.ottochain.ai"
          echo ""
          echo "Services being deployed:"
          echo "- Bridge API: https://staging-bridge.ottochain.ai"
          echo "- GraphQL Gateway: https://staging-gateway.ottochain.ai"
          echo "- Indexer Service: background service"
          echo ""
          echo "Post-deployment validation will include:"
          echo "- Health check endpoints"
          echo "- API smoke tests"
          echo "- Database connectivity"
          echo "- Redis connectivity"

  # Post-deployment testing
  post-deployment:
    name: Post-deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    
    steps:
      - name: Schedule API validation
        run: |
          echo "ðŸ“Š Scheduling post-deployment validation"
          echo "Will validate:"
          echo "- All API endpoints responding"
          echo "- Database connections healthy"
          echo "- GraphQL introspection working"
          echo "- WebSocket subscriptions functional"

      - name: QA team notification
        run: |
          echo "ðŸ“¢ Notifying QA team of staging deployment"
          echo "Staging environment ready for testing"