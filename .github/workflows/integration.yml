name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

env:
  TESSELLATION_VERSION: v4.0.0-rc.2
  NODE_VERSION: '20'
  JAVA_VERSION: '21'

jobs:
  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: ottochain
          POSTGRES_PASSWORD: ottochain
          POSTGRES_DB: ottochain_identity
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U ottochain"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout ottochain-services
        uses: actions/checkout@v4

      - name: Checkout ottochain
        uses: actions/checkout@v4
        with:
          repository: scasplte2/ottochain
          path: ottochain
          ref: main

      - name: Checkout tessellation
        uses: actions/checkout@v4
        with:
          repository: Constellation-Labs/tessellation
          path: tessellation
          ref: ${{ env.TESSELLATION_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: pnpm-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install

      - name: Build services
        run: pnpm build

      - name: Push database schema
        env:
          DATABASE_URL: postgresql://ottochain:ottochain@localhost:5432/ottochain_identity
        run: pnpm db:push --skip-generate

      - name: Cache tessellation assemblies
        uses: actions/cache@v4
        with:
          path: |
            tessellation/modules/*/target
            tessellation/docker/jars
          key: tessellation-${{ env.TESSELLATION_VERSION }}-${{ hashFiles('tessellation/build.sbt') }}
          restore-keys: |
            tessellation-${{ env.TESSELLATION_VERSION }}-

      - name: Build tessellation
        working-directory: tessellation
        run: |
          # Note: dataL1 doesn't exist in tessellation - it's built from the metagraph (ottochain)
          sbt "sdk/publishLocal; keytool/assembly; wallet/assembly; shared/assembly; \
               dagL0/assembly; dagL1/assembly; currencyL0/assembly; currencyL1/assembly"
          mkdir -p docker/jars
          cp modules/keytool/target/scala-2.13/tessellation-keytool-assembly*.jar docker/jars/keytool.jar
          cp modules/wallet/target/scala-2.13/tessellation-wallet-assembly*.jar docker/jars/wallet.jar
          cp modules/dag-l0/target/scala-2.13/tessellation-dag-l0-assembly*.jar docker/jars/gl0.jar
          cp modules/dag-l1/target/scala-2.13/tessellation-dag-l1-assembly*.jar docker/jars/gl1.jar
          cp modules/currency-l0/target/scala-2.13/tessellation-currency-l0-assembly*.jar docker/jars/ml0.jar
          cp modules/currency-l1/target/scala-2.13/tessellation-currency-l1-assembly*.jar docker/jars/cl1.jar

      - name: Cache ottochain assemblies
        uses: actions/cache@v4
        with:
          path: |
            ottochain/modules/*/target
          key: ottochain-${{ hashFiles('ottochain/build.sbt', 'ottochain/project/*.sbt', 'ottochain/project/*.scala') }}
          restore-keys: ottochain-

      - name: Build ottochain metagraph
        working-directory: ottochain
        run: |
          sbt "currencyL0/assembly; dataL1/assembly"

      - name: Start metagraph cluster
        working-directory: tessellation/docker
        run: |
          # Ensure scripts are executable (git checkout can lose permissions)
          chmod +x bin/*.sh
          
          # Enable webhook feature by adding WEBHOOK_URL to ml0 environment in compose file
          # The actual callback URL is registered via API; this just enables the feature
          sed -i 's/- CL_DOCKER_ID=ml0/- WEBHOOK_URL=http:\/\/webhook-enabled\/\n      - CL_DOCKER_ID=ml0/' docker-compose.metagraph.yaml
          
          # Verify the change was applied
          grep WEBHOOK_URL docker-compose.metagraph.yaml || echo "WARNING: WEBHOOK_URL not added!"
          
          # Use compose-runner which handles key generation, env setup, and container orchestration
          # --skip-assembly since we already built everything in prior steps
          ./bin/compose-runner.sh --up --metagraph=$(pwd)/../../ottochain --dl1 --skip-assembly

      - name: Wait for metagraph healthy
        run: |
          echo "=== Waiting for GL0 ==="
          for i in {1..90}; do
            if curl -s http://localhost:9000/node/info | grep -q '"state":"Ready"'; then
              echo "GL0 ready after ${i}s"
              break
            fi
            sleep 1
            if [ $i -eq 90 ]; then echo "GL0 timeout"; docker logs gl0-0 2>&1 | tail -30 || true; exit 1; fi
          done
          
          echo "=== Waiting for ML0 (may take longer on CI) ==="
          for i in {1..180}; do
            if curl -s http://localhost:9200/node/info | grep -q '"state":"Ready"'; then
              echo "ML0 ready after ${i}s"
              break
            fi
            sleep 1
            if [ $i -eq 180 ]; then echo "ML0 timeout"; docker logs ml0-0 2>&1 | tail -30 || true; exit 1; fi
          done
          
          echo "=== Waiting for DL1 ==="
          for i in {1..180}; do
            if curl -s http://localhost:9400/node/info | grep -q '"state":"Ready"'; then
              echo "DL1 ready after ${i}s"
              break
            fi
            sleep 1
            if [ $i -eq 180 ]; then echo "DL1 timeout"; docker logs dl1-0 2>&1 | tail -30 || true; exit 1; fi
          done
          
          echo "=== Waiting for first metagraph snapshot ==="
          # Use /snapshots/latest (ML0's own snapshots) NOT /global-snapshots/latest (synced from GL0)
          for i in {1..120}; do
            ordinal=$(curl -s http://localhost:9200/snapshots/latest | jq -r '.value.ordinal // 0' 2>/dev/null || echo "0")
            if [ "$ordinal" -gt 0 ]; then
              echo "Metagraph producing snapshots (ordinal: $ordinal) after ${i}s"
              exit 0
            fi
            sleep 1
          done
          echo "Metagraph not producing snapshots"
          echo "=== ML0 /snapshots/latest response ==="
          curl -s http://localhost:9200/snapshots/latest | jq . || true
          echo "=== ML0 logs ==="
          docker logs ml0-0 2>&1 | tail -50 || true
          exit 1

      - name: Setup webhook proxy
        run: |
          # ML0 container can't reach localhost directly, so we run a socat proxy
          # on the tessellation_common network that forwards to host.docker.internal
          docker run -d --name webhook-proxy \
            --network tessellation_common \
            --add-host=host.docker.internal:host-gateway \
            alpine/socat \
            TCP-LISTEN:3031,fork,reuseaddr TCP:host.docker.internal:3031
          
          sleep 2
          
          # Get proxy container IP
          PROXY_IP=$(docker inspect webhook-proxy --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
          echo "PROXY_IP=$PROXY_IP" >> $GITHUB_ENV
          echo "Webhook proxy running at $PROXY_IP:3031"

      - name: Start indexer
        env:
          DATABASE_URL: postgresql://ottochain:ottochain@localhost:5432/ottochain_identity
          METAGRAPH_ML0_URL: http://localhost:9200
          METAGRAPH_DL1_URL: http://localhost:9400
          INDEXER_PORT: 3031
        run: |
          # Use proxy IP from previous step for webhook callback
          export INDEXER_CALLBACK_URL="http://${PROXY_IP}:3031/webhook/snapshot"
          echo "Indexer callback URL: $INDEXER_CALLBACK_URL"
          node packages/indexer/dist/index.js &
          sleep 3
          curl -s http://localhost:3031/health | grep -q '"status":"ok"'
          # Verify proxy connectivity from ML0
          docker exec ml0-0 curl -sf http://$PROXY_IP:3031/health

      - name: Run webhook integration tests
        env:
          ML0_URL: http://localhost:9200
          INDEXER_URL: http://localhost:3031
          HOST_IP: ${{ env.PROXY_IP }}
        run: npx tsx scripts/test-webhook.ts

      - name: Start Redis for bridge
        run: |
          docker run -d --name redis-ci -p 6379:6379 redis:alpine
          sleep 2
          docker exec redis-ci redis-cli ping

      - name: Start bridge
        env:
          DATABASE_URL: postgresql://ottochain:ottochain@localhost:5432/ottochain_identity
          METAGRAPH_ML0_URL: http://localhost:9200
          METAGRAPH_DL1_URL: http://localhost:9400
          BRIDGE_PORT: 3030
        run: |
          node packages/bridge/dist/index.js &
          sleep 3
          curl -s http://localhost:3030/health | grep -q '"status":"ok"'
          echo "Bridge is healthy"

      - name: Run traffic generator integration test
        env:
          BRIDGE_URL: http://localhost:3030
          ML0_URL: http://localhost:9200
        run: npx tsx packages/traffic-generator/test/integration.test.ts

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Container list ==="
          docker ps -a || true
          echo "=== GL0 Logs ==="
          docker logs gl0-0 2>&1 | tail -100 || true
          echo "=== ML0 Logs ==="
          docker logs ml0-0 2>&1 | tail -100 || true
          echo "=== DL1 Logs ==="
          docker logs dl1-0 2>&1 | tail -100 || true
          echo "=== Webhook Proxy Logs ==="
          docker logs webhook-proxy 2>&1 | tail -50 || true
          echo "=== Webhook Subscribers ==="
          curl -s http://localhost:9200/data-application/v1/webhooks/subscribers | jq . || true
          echo "=== Indexer Logs ==="
          cat /tmp/indexer.log 2>/dev/null | tail -50 || true

      - name: Cleanup
        if: always()
        working-directory: tessellation/docker
        run: |
          docker rm -f webhook-proxy 2>/dev/null || true
          docker rm -f redis-ci 2>/dev/null || true
          chmod +x bin/*.sh 2>/dev/null || true
          ./bin/compose-runner.sh --down || true
