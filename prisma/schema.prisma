generator client {
  provider      = "prisma-client-js"
  // node:20-slim uses Debian Bookworm with OpenSSL 3.0
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Agent identity registered on OttoChain
model Agent {
  id                      Int            @id @default(autoincrement())
  address                 String         @unique @db.VarChar(64)
  publicKey               String         @db.VarChar(128)
  displayName             String?        @db.VarChar(255)
  reputation              Int            @default(10)
  state                   AgentState     @default(REGISTERED)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  fiberId                 String?        @unique @db.VarChar(64)
  snapshotOrdinal         BigInt
  attestationsReceived    Attestation[]  @relation("AttestationTarget")
  attestationsIssued      Attestation[]  @relation("AttestationIssuer")
  contractsAsCounterparty Contract[]     @relation("ContractCounterparty")
  contractsAsProposer     Contract[]     @relation("ContractProposer")
  platformLinks           PlatformLink[]
  reputationHistory       ReputationHistory[]

  @@index([reputation(sort: Desc)])
  @@index([state])
  @@index([createdAt])
}

/// Platform identity linked to an agent
model PlatformLink {
  id               Int      @id @default(autoincrement())
  agentId          Int
  platform         Platform
  platformUserId   String   @db.VarChar(128)
  platformUsername String?  @db.VarChar(255)
  linkedAt         DateTime @default(now())
  verified         Boolean  @default(false)
  agent            Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([platform, platformUserId])
  @@index([agentId])
}

/// Reputation attestation
model Attestation {
  id              Int             @id @default(autoincrement())
  agentId         Int
  type            AttestationType
  issuerId        Int?
  issuerPlatform  Platform?
  delta           Int
  reason          String?
  metadata        Json?
  createdAt       DateTime        @default(now())
  txHash          String          @db.VarChar(64)
  snapshotOrdinal BigInt
  agent           Agent           @relation("AttestationTarget", fields: [agentId], references: [id], onDelete: Cascade)
  issuer          Agent?          @relation("AttestationIssuer", fields: [issuerId], references: [id])

  @@index([agentId])
  @@index([type])
  @@index([createdAt])
}

/// Agent-to-agent contract
model Contract {
  id              Int           @id @default(autoincrement())
  contractId      String        @unique @db.VarChar(64)
  proposerId      Int
  counterpartyId  Int
  state           ContractState
  terms           Json
  proposedAt      DateTime      @default(now())
  acceptedAt      DateTime?
  completedAt     DateTime?
  fiberId         String        @unique @db.VarChar(64)
  snapshotOrdinal BigInt
  counterparty    Agent         @relation("ContractCounterparty", fields: [counterpartyId], references: [id])
  proposer        Agent         @relation("ContractProposer", fields: [proposerId], references: [id])

  @@index([proposerId])
  @@index([counterpartyId])
  @@index([state])
}

/// Reputation history for tracking changes over time
model ReputationHistory {
  id              Int      @id @default(autoincrement())
  agentId         Int
  reputation      Int
  delta           Int      @default(0)
  reason          String?  @db.VarChar(255)
  recordedAt      DateTime @default(now())
  snapshotOrdinal BigInt
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId, recordedAt])
  @@index([recordedAt])
}

/// Generic state machine fiber (chain-agnostic)
model Fiber {
  fiberId         String   @id @db.VarChar(64)
  workflowType    String   @db.VarChar(128)  // definition.metadata.name
  workflowDesc    String?  @db.VarChar(512)  // definition.metadata.description
  currentState    String   @db.VarChar(64)
  status          FiberStatus @default(ACTIVE)
  owners          String[] // DAG addresses
  stateData       Json
  definition      Json     // full state machine definition
  sequenceNumber  Int      @default(0)
  createdOrdinal  BigInt            // ML0 ordinal when created
  updatedOrdinal  BigInt            // ML0 ordinal when last updated
  createdGl0Ordinal BigInt?         // GL0 ordinal when creation confirmed
  updatedGl0Ordinal BigInt?         // GL0 ordinal when last update confirmed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Transitions history
  transitions     FiberTransition[]

  @@index([workflowType])
  @@index([status])
  @@index([currentState])
  @@index([createdAt])
  @@index([owners])
}

/// State transition record for a fiber
model FiberTransition {
  id              Int      @id @default(autoincrement())
  fiberId         String   @db.VarChar(64)
  eventName       String   @db.VarChar(64)
  fromState       String   @db.VarChar(64)
  toState         String   @db.VarChar(64)
  success         Boolean  @default(true)
  gasUsed         Int      @default(0)
  payload         Json?
  snapshotOrdinal BigInt            // ML0 ordinal
  gl0Ordinal      BigInt?           // GL0 ordinal when confirmed
  createdAt       DateTime @default(now())
  fiber           Fiber    @relation(fields: [fiberId], references: [fiberId], onDelete: Cascade)

  @@index([fiberId, createdAt])
  @@index([eventName])
  @@index([snapshotOrdinal])
}

enum FiberStatus {
  ACTIVE
  ARCHIVED
  FAILED
}

/// Track indexing progress with GL0 confirmation status
model IndexedSnapshot {
  ordinal          BigInt         @id
  hash             String         @db.VarChar(64)
  status           SnapshotStatus @default(PENDING)
  gl0Ordinal       BigInt?        // Global L0 ordinal when confirmed
  confirmedAt      DateTime?      // When GL0 included this snapshot
  indexedAt        DateTime       @default(now())
  agentsUpdated    Int            @default(0)
  contractsUpdated Int            @default(0)
  fibersUpdated    Int            @default(0)

  @@index([status])
  @@index([hash])
}

enum SnapshotStatus {
  PENDING    // Received from ML0, not yet in GL0
  CONFIRMED  // Included in GL0 global snapshot
  ORPHANED   // Rollback - was pending but different hash confirmed
}

/// Webhook subscribers for snapshot notifications
model SnapshotSubscriber {
  id          Int       @id @default(autoincrement())
  callbackUrl String    @unique @db.VarChar(512)
  secret      String?   @db.VarChar(128)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  lastPingAt  DateTime?
  failCount   Int       @default(0)

  @@index([active])
}

enum AgentState {
  UNSPECIFIED
  REGISTERED
  ACTIVE
  CHALLENGED
  SUSPENDED
  PROBATION
  WITHDRAWN
}

enum Platform {
  DISCORD
  TELEGRAM
  TWITTER
  GITHUB
  CUSTOM
}

enum AttestationType {
  COMPLETION
  VOUCH
  VIOLATION
  BEHAVIORAL
}

enum ContractState {
  UNSPECIFIED
  PROPOSED
  ACTIVE
  COMPLETED
  REJECTED
  DISPUTED
  CANCELLED
}

/// Time-series stats for trend calculations
/// Stored in time buckets (5-min granularity for 24h, hourly for 7d, daily for 30d)
model StatsSnapshot {
  id                 Int              @id @default(autoincrement())
  bucketTime         DateTime         // Rounded to bucket interval
  granularity        StatsGranularity @default(FIVE_MIN)
  
  // Core metrics
  totalAgents        Int
  activeAgents       Int
  totalContracts     Int
  completedContracts Int
  totalAttestations  Int
  totalFibers        Int
  snapshotOrdinal    BigInt
  
  // Derived metrics (for settlement time proxy)
  snapshotsInPeriod  Int              @default(1)  // How many ML0 snapshots in this bucket
  
  createdAt          DateTime         @default(now())

  @@unique([bucketTime, granularity])
  @@index([bucketTime])
  @@index([granularity, bucketTime])
}

enum StatsGranularity {
  FIVE_MIN  // Kept for 24 hours
  HOURLY    // Kept for 7 days  
  DAILY     // Kept for 30 days
}

/// Rejected transactions from ML0 validation failures
/// Transactions accepted by DL1 but rejected by ML0 contextual validation
model RejectedTransaction {
  id          Int       @id @default(autoincrement())
  ordinal     BigInt                          // Snapshot ordinal when rejection occurred
  timestamp   DateTime                        // When the rejection happened
  updateType  String    @db.VarChar(64)       // CreateStateMachine, TransitionStateMachine, etc.
  fiberId     String    @db.VarChar(64)       // Target fiber UUID
  updateHash  String    @unique @db.VarChar(64) // Hash for dedup
  errors      Json                            // Array of {code, message}
  signers     String[]                        // Signer IDs from proofs
  rawPayload  Json?                           // Original webhook payload (optional)
  createdAt   DateTime  @default(now())

  @@index([fiberId])
  @@index([ordinal(sort: Desc)])
  @@index([updateType])
  @@index([createdAt(sort: Desc)])
}

/// Pre-computed deltas cached for fast API reads
model StatsDelta {
  id           Int      @id @default(autoincrement())
  period       String   @unique @db.VarChar(16)  // "1h", "24h", "7d"
  
  // Absolute deltas
  agentsDelta        Int      @default(0)
  contractsDelta     Int      @default(0)
  attestationsDelta  Int      @default(0)
  fibersDelta        Int      @default(0)
  
  // Percentage changes
  agentsPct          Float    @default(0)
  contractsPct       Float    @default(0)
  successRatePct     Float    @default(0)
  
  // Activity metrics
  avgSnapshotsPerHour Float   @default(0)  // Proxy for "throughput"
  
  computedAt   DateTime @default(now())
}
